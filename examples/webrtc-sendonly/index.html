<html lang="en">

<head>
  <meta charset="utf-8" http-equiv="Content-Language" content="en" />
  <meta name="description" content="WebRTC code samples">
  <meta name="viewport" content="width=device-width, user-scalable=yes, initial-scale=1, maximum-scale=1">
  <meta itemprop="description" content="Client-side WebRTC code samples">
  <meta itemprop="name" content="WebRTC code samples">
  <meta name="mobile-web-app-capable" content="yes">
  <meta id="theme-color" name="theme-color" content="#ffffff">
  <link href="bootstrap.min.css" rel="stylesheet">
  <script src="bootstrap.bundle.min.js"></script>

  <title>GStreamer webrtc camera</title>
  <script>
    var websocketConnection;
    var webrtcPeerConnection;
    var webrtcConfiguration;
    var reportError;
    var reconnectTimerId;

    const turn_config = {
      'iceServers': [{
        urls: 'turn:192.168.1.100:3478',
        username: "test",
        credential: "test123"
      }]
    };

    const stun_config = {
      'iceServers': [{
        urls: 'stun:stun.l.google.com:19302'
      }]
    };

    function onLocalDescription(desc) {
      console.log("Local description: " + JSON.stringify(desc));
      webrtcPeerConnection.setLocalDescription(desc).then(function () {
        websocketConnection.send(JSON.stringify({ type: "sdp", "data": webrtcPeerConnection.localDescription }));
      }).catch(console.erro);
    }

    function onIncomingSDP(sdp) {
      console.log("Incoming SDP: " + JSON.stringify(sdp));
      webrtcPeerConnection.setRemoteDescription(sdp).catch(console.erro);
      webrtcPeerConnection.createAnswer().then(onLocalDescription).catch(console.error);
    }


    function onIncomingICE(ice) {
      var candidate = new RTCIceCandidate(ice);
      console.log("Incoming ICE: " + JSON.stringify(ice));
      webrtcPeerConnection.addIceCandidate(candidate).catch(console.erro);
    }

    function onAddRemoteStream(event) {
      const el = document.getElementById('video0');
      el.srcObject = event.streams[0]
      el.autoplay = true
      el.controls = true
    }

    function onIceCandidate(event) {
      if (event.candidate == null)
        return;
      console.log("Sending ICE candidate out: " + JSON.stringify(event.candidate));
      websocketConnection.send(JSON.stringify({ "type": "ice", "data": event.candidate }));
    }

    function onServerMessage(event) {
      var msg;

      try {
        msg = JSON.parse(event.data);
      } catch (e) {
        return;
      }

      switch (msg.type) {
        case "sdp": onIncomingSDP(msg.data); break;
        case "ice": onIncomingICE(msg.data); break;
        default: break;
      }
    }


    function playStream(hostname, port, path) {
      var l = window.location;
      var wsHost = (hostname != undefined) ? hostname : l.hostname;
      var wsPort = (port != undefined) ? port : l.port;
      var wsPath = (path != undefined) ? path : "ws";
      if (wsPort)
        wsPort = ":" + wsPort;
      var wsUrl = "ws://" + wsHost + wsPort + "/" + wsPath;

      webrtcPeerConnection = new RTCPeerConnection(stun_config);
      webrtcPeerConnection.ontrack = onAddRemoteStream;
      webrtcPeerConnection.onicecandidate = onIceCandidate;
      webrtcPeerConnection.addTransceiver('video', { 'direction': 'recvonly' });
      webrtcPeerConnection.addTransceiver('audio', { 'direction': 'recvonly' });
      if (reconnectTimerId)
        clearTimeout(reconnectTimerId);
      return new Promise((resolve, reject) => {
        websocketConnection = new WebSocket(wsUrl);
        websocketConnection.onopen = () => {
          resolve(websocketConnection);
        }
        websocketConnection.onerror = (err) => {
          reject(err);
        }
        websocketConnection.addEventListener("message", onServerMessage);
        websocketConnection.addEventListener("close", () => {
          reconnectTimerId = setTimeout(() => {
            console.log("reconnect websockets");
            playStream(null, null, null).then(() => {
              if (reconnectTimerId)
                clearTimeout(reconnectTimerId);
            }).catch(err => {
              console.log("ws error: " + err);
            });
          }, 5000);
        });
      });
    }

    window.addEventListener("load", (event) => {
      playStream(null, null, null).then(()=>{
        if (reconnectTimerId)
          clearTimeout(reconnectTimerId);
      }).catch( err=>{
        console.log("ws error: " + err);
        reconnectTimerId = setTimeout(() => {
          console.log("reconnect websockets");
          playStream(null, null, null);
        }, 5000);
      });
    });

  </script>
</head>

<body>
  <div>
    <h2 class="text-center">Gsteramer HLS 直播流服务</h2>
    <div class="text-center container-fluid p-0 m-0">
      <video class="w-75" id="video0" playsinline autoplay></video>
    </div>
  </div>
</body>

</html>